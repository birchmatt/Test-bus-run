<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Student Voice Tracker</title>
    <meta name="description" content="Voice-powered student boarding tracker for bus drivers">
    <meta name="author" content="Bus Transportation Department">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Bus Tracker">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .run-section {
            margin-bottom: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .run-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: stretch;
            flex-wrap: wrap;
        }

        select, input[type="text"], input[type="email"] {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            flex: 1;
            min-width: 200px;
        }

        select:focus, input[type="text"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .new-run-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            white-space: nowrap;
            min-width: 140px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .new-run-btn:hover, .new-run-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .new-run-btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .current-run {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .voice-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .voice-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .voice-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            min-width: 120px;
        }

        .voice-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .voice-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 6px 30px rgba(220, 53, 69, 0.6); }
            100% { box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3); }
        }

        .transcript-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .transcript-area.has-content {
            border-color: #28a745;
            background: #d4edda;
        }

        .add-name-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-btn {
            background: linear-gradient(135deg, #feca57, #ff9ff3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(254, 202, 87, 0.3);
        }

        .add-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 202, 87, 0.4);
        }

        .add-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .students-log {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .students-log h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .student-list {
            list-style: none;
        }

        .student-item {
            background: linear-gradient(135deg, #f1f3f4, #e8eaed);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .student-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .student-name {
            font-weight: 600;
            color: #495057;
        }

        .student-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .browser-warning {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .url-copy {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 5px 0;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .voice-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .run-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .run-controls select,
            .run-controls input[type="text"] {
                min-width: unset;
                width: 100%;
            }
            
            .new-run-btn {
                width: 100%;
                min-width: unset;
                padding: 15px;
                font-size: 1.1rem;
            }
            
            .add-name-section {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚌 Bus Student Tracker</h1>
            <p>Voice-powered student boarding log</p>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status-message status-info">
                Ready to start tracking students! Select or create a new run below.
            </div>

            <!-- Run Management Section -->
            <div class="run-section">
                <h2 style="color: #495057; margin-bottom: 20px;">📍 Run Management</h2>
                
                <div class="run-controls">
                    <select id="runSelect">
                        <option value="">Select existing run...</option>
                    </select>
                    <input type="text" id="newRunName" placeholder="Enter new run name (e.g., Morning Route A)">
                    <button class="new-run-btn" id="createRunBtn">Create New Run</button>
                </div>
                
                <!-- Debug section for mobile testing -->
                <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 10px;">
                    <strong>Debug Info:</strong>
                    <div id="debugInfo">Ready for testing...</div>
                    <button onclick="window.testCreateRun()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-top: 10px;">
                        🧪 Manual Test Create Run
                    </button>
                </div>
                
                <div id="currentRunDisplay" class="current-run" style="display: none;">
                    <strong>Current Run:</strong> <span id="currentRunName"></span><br>
                    <strong>Started:</strong> <span id="currentRunTime"></span>
                </div>
            </div>

            <!-- Voice Recording Section -->
            <div class="voice-section">
                <h2 style="color: #495057; margin-bottom: 20px; text-align: center;">🎤 Voice Recording</h2>
                
                <div class="voice-controls">
                    <button id="startBtn" class="voice-btn" onclick="startRecording()">Start Recording</button>
                    <button id="stopBtn" class="voice-btn" onclick="stopRecording()" disabled>Stop Recording</button>
                    <button id="testMicBtn" class="voice-btn" onclick="testMicrophone()" style="background: linear-gradient(135deg, #feca57, #ff9ff3);">Test Microphone</button>
                </div>
                
                <div id="transcript" class="transcript-area">
                    Transcript will appear here... Click "Start Recording" and say student names.
                </div>
                
                <div class="add-name-section">
                    <input type="text" id="manualName" placeholder="Or type a student name manually">
                    <button class="add-btn" onclick="addManualName()">Add Name</button>
                    <button class="add-btn" onclick="if(!isProcessingNames) addTranscriptNames()" id="addTranscriptBtn" disabled>Add All Names from Voice</button>
                    <button class="add-btn" onclick="clearTranscript()" style="background: linear-gradient(135deg, #6c757d, #495057);">Clear Transcript</button>
                </div>
            </div>

            <!-- Students Log Section -->
            <div class="students-log">
                <h3>📝 Students on Current Run</h3>
                <ul id="studentsList" class="student-list">
                    <!-- Students will be added here dynamically -->
                </ul>
                <div id="noStudents" style="text-align: center; color: #6c757d; font-style: italic; padding: 20px;">
                    No students logged for this run yet.
                </div>
                
                <!-- Export Section -->
                <div class="export-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <h4 style="color: #495057; margin-bottom: 20px;">📤 Export & Send Data</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <input type="email" id="emailAddress" placeholder="Enter email address (e.g., supervisor@school.edu)" 
                               style="width: 300px; max-width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="add-btn" onclick="exportToCSV()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                            📊 Download CSV
                        </button>
                        <button class="add-btn" onclick="sendEmail()" style="background: linear-gradient(135deg, #007bff, #6f42c1);">
                            📧 Send Email
                        </button>
                        <button class="add-btn" onclick="purgeCurrentRun()" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            🗑️ Purge Current Run
                        </button>
                        <button class="add-btn" onclick="purgeAllRuns()" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                            💥 Purge All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let recognition;
        let currentTranscript = '';
        let currentRun = null;
        let runs = JSON.parse(localStorage.getItem('busRuns') || '{}');
        let students = JSON.parse(localStorage.getItem('busStudents') || '{}');
        let voiceInactivityTimer = null;
        let accumulatedTranscript = '';
        let lastSpeechTime = null;
        let isProcessingNames = false; // Prevent multiple simultaneous processing
        let isRecording = false; // Track recording state
        let shouldStopRecording = false; // Flag for manual stop

        // Core functions
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
        }

        // Debug function for manual testing
        window.testCreateRun = function() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = 'Testing create run...<br>';
            
            try {
                const runName = document.getElementById('newRunName').value.trim() || 'Test Run ' + Date.now();
                debugDiv.innerHTML += `Run name: ${runName}<br>`;
                
                const runId = Date.now().toString();
                debugDiv.innerHTML += `Run ID: ${runId}<br>`;
                
                runs[runId] = {
                    name: runName,
                    startTime: new Date().toLocaleString()
                };
                
                students[runId] = [];
                debugDiv.innerHTML += 'Data structures updated<br>';
                
                localStorage.setItem('busRuns', JSON.stringify(runs));
                localStorage.setItem('busStudents', JSON.stringify(students));
                debugDiv.innerHTML += 'LocalStorage updated<br>';
                
                currentRun = runId;
                document.getElementById('newRunName').value = '';
                
                loadExistingRuns();
                document.getElementById('runSelect').value = runId;
                updateDisplay();
                
                debugDiv.innerHTML += '<strong style="color: green;">SUCCESS!</strong><br>';
                updateStatus(`✅ Manual test created run: ${runName}`, 'success');
                
            } catch (error) {
                debugDiv.innerHTML += `<strong style="color: red;">ERROR: ${error.message}</strong><br>`;
                console.error('Manual test error:', error);
            }
        };

        function createNewRun() {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.innerHTML = 'createNewRun() called...<br>';
            }
            
            try {
                const runNameInput = document.getElementById('newRunName');
                if (!runNameInput) {
                    throw new Error('Input field not found');
                }
                
                const runName = runNameInput.value.trim();
                if (debugDiv) debugDiv.innerHTML += `Input value: "${runName}"<br>`;
                
                if (!runName) {
                    updateStatus('⚠️ Please enter a run name.', 'error');
                    if (debugDiv) debugDiv.innerHTML += 'No run name entered<br>';
                    return;
                }

                const runId = Date.now().toString();
                const startTime = new Date().toLocaleString();
                
                if (debugDiv) debugDiv.innerHTML += `Creating run ID: ${runId}<br>`;
                
                runs[runId] = {
                    name: runName,
                    startTime: startTime
                };
                
                students[runId] = [];
                
                localStorage.setItem('busRuns', JSON.stringify(runs));
                localStorage.setItem('busStudents', JSON.stringify(students));
                
                if (debugDiv) debugDiv.innerHTML += 'Data saved<br>';
                
                currentRun = runId;
                runNameInput.value = '';
                
                loadExistingRuns();
                document.getElementById('runSelect').value = runId;
                updateDisplay();
                updateStatus(`✅ Created new run: ${runName}`, 'success');
                
                if (debugDiv) debugDiv.innerHTML += '<strong style="color: green;">Function completed successfully!</strong><br>';
                
            } catch (error) {
                console.error('Error in createNewRun:', error);
                updateStatus('❌ Error creating run: ' + error.message, 'error');
                if (debugDiv) debugDiv.innerHTML += `<strong style="color: red;">Error: ${error.message}</strong><br>`;
            }
        }

        function loadExistingRuns() {
            const select = document.getElementById('runSelect');
            select.innerHTML = '<option value="">Select existing run...</option>';
            
            Object.keys(runs).forEach(runId => {
                const option = document.createElement('option');
                option.value = runId;
                option.textContent = `${runs[runId].name} (${runs[runId].startTime})`;
                select.appendChild(option);
            });
        }

        function addManualName() {
            const name = document.getElementById('manualName').value.trim();
            if (!name) {
                updateStatus('⚠️ Please enter a student name.', 'error');
                return;
            }
            
            if (!currentRun) {
                updateStatus('⚠️ Please select or create a run first.', 'error');
                return;
            }
            
            // Check for duplicate before adding
            const wasAdded = addStudentToRun(name);
            if (wasAdded) {
                document.getElementById('manualName').value = '';
                updateStatus(`✅ Added ${name}`, 'success');
            } else {
                updateStatus(`⚠️ "${name}" is already in the list.`, 'error');
                document.getElementById('manualName').value = '';
            }
        }

        function addStudentToRun(name) {
            if (!students[currentRun]) {
                students[currentRun] = [];
            }
            
            // Strict duplicate check - normalize whitespace and case
            const normalizedNewName = name.toLowerCase().trim().replace(/\s+/g, ' ');
            
            const isDuplicate = students[currentRun].some(student => {
                const normalizedExisting = student.name.toLowerCase().trim().replace(/\s+/g, ' ');
                return normalizedExisting === normalizedNewName;
            });
            
            if (isDuplicate) {
                console.log(`Duplicate detected: "${name}" matches existing student`);
                return false;
            }
            
            // Add the student
            const studentEntry = {
                name: name.trim(),
                timestamp: new Date().toLocaleString()
            };
            
            students[currentRun].push(studentEntry);
            localStorage.setItem('busStudents', JSON.stringify(students));
            updateStudentsList();
            
            return true;
        }

        function removeStudent(index) {
            if (currentRun && students[currentRun]) {
                students[currentRun].splice(index, 1);
                localStorage.setItem('busStudents', JSON.stringify(students));
                updateStudentsList();
                updateStatus('✅ Student removed from run.', 'success');
            }
        }

        function updateDisplay() {
            const currentRunDisplay = document.getElementById('currentRunDisplay');
            const currentRunName = document.getElementById('currentRunName');
            const currentRunTime = document.getElementById('currentRunTime');
            
            if (currentRun && runs[currentRun]) {
                currentRunDisplay.style.display = 'block';
                currentRunName.textContent = runs[currentRun].name;
                currentRunTime.textContent = runs[currentRun].startTime;
            } else {
                currentRunDisplay.style.display = 'none';
            }
            
            updateStudentsList();
        }

        function updateStudentsList() {
            const studentsList = document.getElementById('studentsList');
            const noStudents = document.getElementById('noStudents');
            
            studentsList.innerHTML = '';
            
            if (!currentRun || !students[currentRun] || students[currentRun].length === 0) {
                noStudents.style.display = 'block';
                return;
            }
            
            noStudents.style.display = 'none';
            
            students[currentRun].forEach((student, index) => {
                const li = document.createElement('li');
                li.className = 'student-item';
                li.innerHTML = `
                    <div>
                        <div class="student-name">${student.name}</div>
                        <div class="student-time">${student.timestamp}</div>
                    </div>
                    <button class="remove-btn" onclick="removeStudent(${index})">Remove</button>
                `;
                studentsList.appendChild(li);
            });
        }

        // Voice recognition functions
        async function testMicrophone() {
            updateStatus('🔍 Testing microphone access...', 'info');
            
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('MediaDevices API not available - page must be served over HTTPS');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                updateStatus('✅ Microphone access granted! Voice recording should work.', 'success');
                return true;
                
            } catch (error) {
                let errorMessage = '❌ Microphone test failed: ';
                
                switch(error.name) {
                    case 'NotAllowedError':
                        errorMessage = '❌ Microphone permission denied. Please allow microphone access in browser settings.';
                        break;
                    case 'NotFoundError':
                        errorMessage = '❌ No microphone found on this device.';
                        break;
                    case 'NotSupportedError':
                        errorMessage = '❌ Microphone not supported - page must be served over HTTPS.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                updateStatus(errorMessage, 'error');
                return false;
            }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    updateStatus('🎤 Listening continuously... Say student names. Recording will continue for 30 seconds after last speech.', 'info');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('startBtn').classList.add('recording');
                    document.getElementById('startBtn').textContent = 'Recording...';
                    lastSpeechTime = Date.now();
                    startInactivityTimer();
                };
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let newFinalTranscript = '';
                    
                    // Process all results to get the complete current transcript
                    for (let i = 0; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            newFinalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update timing for any speech
                    if (newFinalTranscript.trim() || interimTranscript.trim()) {
                        lastSpeechTime = Date.now();
                    }
                    
                    // ACCUMULATE final transcript instead of replacing
                    if (newFinalTranscript.trim()) {
                        accumulatedTranscript += newFinalTranscript;
                        console.log('Added to accumulated transcript:', newFinalTranscript.trim());
                        console.log('Full accumulated transcript:', accumulatedTranscript);
                    }
                    
                    currentTranscript = interimTranscript;
                    
                    // Show accumulated + current interim speech
                    const displayText = (accumulatedTranscript + interimTranscript).trim();
                    document.getElementById('transcript').textContent = displayText || 'Listening...';
                    
                    if (displayText) {
                        document.getElementById('transcript').classList.add('has-content');
                        document.getElementById('addTranscriptBtn').disabled = false;
                    }
                    
                    startInactivityTimer();
                };
                
                recognition.onerror = function(event) {
                    if (event.error === 'no-speech') return;
                    
                    let errorMessage = 'Speech recognition error: ';
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage = '❌ Microphone permission denied. Please allow microphone access.';
                            break;
                        case 'audio-capture':
                            errorMessage = '❌ Audio capture failed. Check your microphone connection.';
                            break;
                        case 'network':
                            errorMessage = '❌ Network error. Check your internet connection.';
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    updateStatus(errorMessage, 'error');
                    clearInactivityTimer();
                    resetRecordingButtons();
                };
                
                recognition.onend = function() {
                    if (document.getElementById('stopBtn').disabled === false) {
                        if (lastSpeechTime && (Date.now() - lastSpeechTime) < 30000) {
                            setTimeout(() => {
                                try {
                                    recognition.start();
                                } catch (e) {}
                            }, 100);
                        } else {
                            handleRecordingEnd();
                        }
                    }
                };
            } else {
                updateStatus('❌ Speech recognition not supported in this browser. Try Google Chrome.', 'error');
                document.getElementById('startBtn').disabled = true;
            }
        }

        function startInactivityTimer() {
            clearInactivityTimer();
            voiceInactivityTimer = setTimeout(() => {
                updateStatus('⏰ 30 seconds of silence detected. Stopping recording...', 'info');
                stopRecording();
            }, 30000);
        }

        function clearInactivityTimer() {
            if (voiceInactivityTimer) {
                clearTimeout(voiceInactivityTimer);
                voiceInactivityTimer = null;
            }
        }

        function handleRecordingEnd() {
            clearInactivityTimer();
            resetRecordingButtons();
            if (accumulatedTranscript.trim()) {
                updateStatus('✅ Recording stopped. Review all accumulated speech and add names.', 'success');
                updateTranscriptDisplay();
            } else {
                updateStatus('⚠️ No speech detected during recording session.', 'error');
            }
        }

        function updateTranscriptDisplay() {
            const transcript = document.getElementById('transcript');
            const displayText = accumulatedTranscript.trim();
            
            if (displayText) {
                transcript.textContent = displayText;
                transcript.classList.add('has-content');
                document.getElementById('addTranscriptBtn').disabled = false;
            } else {
                transcript.textContent = 'Transcript will appear here... Click "Start Recording" and say student names.';
                transcript.classList.remove('has-content');
                document.getElementById('addTranscriptBtn').disabled = true;
            }
        }

        async function startRecording() {
            if (!currentRun) {
                updateStatus('⚠️ Please select or create a run first.', 'error');
                return;
            }
            
            const hasPermission = await testMicrophone();
            if (!hasPermission) return;
            
            if (recognition) {
                document.getElementById('transcript').textContent = 'Requesting microphone access...';
                
                try {
                    recognition.start();
                } catch (error) {
                    if (error.name === 'InvalidStateError') {
                        recognition.stop();
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {
                                updateStatus('❌ Could not start recording: ' + e.message, 'error');
                                resetRecordingButtons();
                            }
                        }, 100);
                    } else {
                        updateStatus('❌ Could not start recording: ' + error.message, 'error');
                        resetRecordingButtons();
                    }
                }
            }
        }

        function stopRecording() {
            console.log('Stop recording button pressed');
            clearInactivityTimer();
            
            if (recognition) {
                try {
                    recognition.stop();
                    recognition.abort(); // Force immediate stop
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                }
            }
            
            // Immediately reset buttons
            resetRecordingButtons();
            
            if (accumulatedTranscript.trim()) {
                updateStatus('✅ Recording stopped. Review transcript and add names.', 'success');
            } else {
                updateStatus('⚠️ Recording stopped. No speech detected.', 'info');
            }
        }

        function resetRecordingButtons() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').classList.remove('recording');
            document.getElementById('startBtn').textContent = 'Start Recording';
        }

        function clearTranscript() {
            accumulatedTranscript = '';
            currentTranscript = '';
            updateTranscriptDisplay();
            updateStatus('🧹 Transcript cleared. Ready for new recording.', 'info');
        }

        function addTranscriptNames() {
            if (isProcessingNames) {
                console.log('Already processing names, skipping...');
                return;
            }
            
            if (!accumulatedTranscript.trim()) {
                updateStatus('⚠️ No transcript available.', 'error');
                return;
            }
            
            if (!currentRun) {
                updateStatus('⚠️ Please select or create a run first.', 'error');
                return;
            }
            
            isProcessingNames = true;
            console.log('=== STARTING NAME PROCESSING ===');
            console.log('Raw accumulated transcript:', `"${accumulatedTranscript}"`);
            
            try {
                // Step 1: Split into words
                let allWords = accumulatedTranscript
                    .trim()
                    .split(/[\s,]+/)
                    .map(word => word.replace(/[^\w'-]/g, '').trim())
                    .filter(word => word.length >= 2);
                
                console.log('Step 1 - All words after split/clean:', allWords);
                
                // Step 2: Filter out obvious non-names
                let filteredWords = allWords.filter(word => {
                    const lower = word.toLowerCase();
                    return !['and', 'the', 'um', 'uh', 'okay'].includes(lower);
                });
                
                console.log('Step 2 - After filtering non-names:', filteredWords);
                
                if (filteredWords.length === 0) {
                    updateStatus('⚠️ No valid words found.', 'error');
                    return;
                }
                
                // Step 3: Remove duplicates within this session's transcript
                let uniqueWords = [];
                let seenInTranscript = new Set();
                
                filteredWords.forEach((word, index) => {
                    const lowerWord = word.toLowerCase();
                    console.log(`Processing word ${index + 1}: "${word}" (lowercase: "${lowerWord}")`);
                    
                    if (seenInTranscript.has(lowerWord)) {
                        console.log(`  -> DUPLICATE in transcript, skipping`);
                    } else {
                        seenInTranscript.add(lowerWord);
                        const properName = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        uniqueWords.push(properName);
                        console.log(`  -> NEW in transcript, keeping as: "${properName}"`);
                    }
                });
                
                console.log('Step 3 - Unique words from transcript:', uniqueWords);
                
                // Step 4: Check against existing students and add
                let addedCount = 0;
                let skippedCount = 0;
                
                const existingStudents = students[currentRun] || [];
                console.log('Existing students:', existingStudents.map(s => s.name));
                
                uniqueWords.forEach((name, index) => {
                    console.log(`\nTrying to add student ${index + 1}: "${name}"`);
                    const wasAdded = addStudentToRun(name);
                    if (wasAdded) {
                        addedCount++;
                        console.log(`  -> ADDED successfully`);
                    } else {
                        skippedCount++;
                        console.log(`  -> SKIPPED (already exists)`);
                    }
                });
                
                console.log(`\n=== FINAL RESULTS ===`);
                console.log(`Added: ${addedCount}, Skipped: ${skippedCount}`);
                console.log('Current student list:', (students[currentRun] || []).map(s => s.name));
                
                // Clear transcript
                accumulatedTranscript = '';
                currentTranscript = '';
                updateTranscriptDisplay();
                
                // Provide feedback
                if (addedCount > 0) {
                    let message = `✅ Added ${addedCount} name(s)`;
                    if (skippedCount > 0) {
                        message += ` (${skippedCount} were duplicates)`;
                    }
                    updateStatus(message, 'success');
                } else if (skippedCount > 0) {
                    updateStatus(`ℹ️ All ${skippedCount} names were already in the list.`, 'info');
                } else {
                    updateStatus('⚠️ No valid names found.', 'error');
                }
                
            } catch (error) {
                console.error('Error processing names:', error);
                updateStatus('❌ Error processing names: ' + error.message, 'error');
            } finally {
                isProcessingNames = false;
            }
        }

        // Export and purge functions
        function exportToCSV() {
            if (!currentRun || !students[currentRun] || students[currentRun].length === 0) {
                updateStatus('⚠️ No students to export for current run.', 'error');
                return;
            }
            
            const runInfo = runs[currentRun];
            const studentList = students[currentRun];
            
            let csvContent = 'Run Name,Run Start Time,Student Name,Boarding Time\n';
            
            studentList.forEach(student => {
                csvContent += `"${runInfo.name}","${runInfo.startTime}","${student.name}","${student.timestamp}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bus_run_${runInfo.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus(`✅ CSV file downloaded: ${studentList.length} students exported.`, 'success');
            
            setTimeout(() => {
                purgeCurrentRunData();
                updateStatus(`🧹 Run data purged after successful export.`, 'info');
            }, 1000);
        }

        function sendEmail() {
            const emailAddress = document.getElementById('emailAddress').value.trim();
            
            if (!emailAddress) {
                updateStatus('⚠️ Please enter an email address.', 'error');
                return;
            }
            
            if (!currentRun || !students[currentRun] || students[currentRun].length === 0) {
                updateStatus('⚠️ No students to send for current run.', 'error');
                return;
            }
            
            const runInfo = runs[currentRun];
            const studentList = students[currentRun];
            
            const subject = `Bus Run Report: ${runInfo.name} - ${new Date().toLocaleDateString()}`;
            
            let emailBody = `Bus Run Report\n\n`;
            emailBody += `Run Name: ${runInfo.name}\n`;
            emailBody += `Run Start Time: ${runInfo.startTime}\n`;
            emailBody += `Total Students: ${studentList.length}\n`;
            emailBody += `Report Generated: ${new Date().toLocaleString()}\n\n`;
            emailBody += `Student List:\n`;
            emailBody += `================\n`;
            
            studentList.forEach((student, index) => {
                emailBody += `${index + 1}. ${student.name} - Boarded at ${student.timestamp}\n`;
            });
            
            emailBody += `\n\nThis report was generated by the Bus Student Voice Tracker app.`;
            
            const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailtoLink;
            
            updateStatus(`📧 Email opened with run data for ${studentList.length} students.`, 'success');
            
            setTimeout(() => {
                purgeCurrentRunData();
                updateStatus(`🧹 Run data purged after sending email.`, 'info');
            }, 2000);
        }

        function purgeCurrentRun() {
            if (!currentRun) {
                updateStatus('⚠️ No current run selected.', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to permanently delete all data for "${runs[currentRun].name}"?`)) {
                return;
            }
            
            purgeCurrentRunData();
            updateStatus(`🗑️ Current run "${runs[currentRun].name}" has been purged.`, 'success');
        }

        function purgeCurrentRunData() {
            if (currentRun && runs[currentRun]) {
                delete runs[currentRun];
                delete students[currentRun];
                
                localStorage.setItem('busRuns', JSON.stringify(runs));
                localStorage.setItem('busStudents', JSON.stringify(students));
                
                currentRun = null;
                document.getElementById('runSelect').value = '';
                
                loadExistingRuns();
                updateDisplay();
                
                accumulatedTranscript = '';
                currentTranscript = '';
                updateTranscriptDisplay();
            }
        }

        function purgeAllRuns() {
            if (!confirm('⚠️ WARNING: This will permanently delete ALL runs and student data. This cannot be undone!\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('🚨 FINAL CONFIRMATION: Delete ALL bus run data permanently?')) {
                return;
            }
            
            runs = {};
            students = {};
            currentRun = null;
            accumulatedTranscript = '';
            currentTranscript = '';
            
            localStorage.removeItem('busRuns');
            localStorage.removeItem('busStudents');
            
            loadExistingRuns();
            updateDisplay();
            updateTranscriptDisplay();
            
            updateStatus('💥 All bus run data has been permanently purged.', 'success');
        }

        // Browser compatibility functions
        function checkAndRedirectToHTTPS() {
            if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                const httpsUrl = location.href.replace('http:', 'https:');
                const warningDiv = document.createElement('div');
                warningDiv.className = 'status-message status-error';
                warningDiv.innerHTML = `
                    <strong>🔒 HTTPS Required for Microphone Access</strong><br>
                    This page needs to be served over HTTPS to access the microphone.<br><br>
                    <strong>Try this secure URL:</strong><br>
                    <a href="${httpsUrl}" style="color: #007bff; font-weight: bold;">${httpsUrl}</a><br><br>
                    <button onclick="window.location.href='${httpsUrl}'" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        🔒 Switch to HTTPS
                    </button>
                `;
                
                const container = document.querySelector('.content');
                container.insertBefore(warningDiv, container.firstChild);
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').textContent = 'HTTPS Required';
                return false;
            }
            return true;
        }

        function detectBrowser() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            return {
                isChrome: isChrome && !isEdge,
                isEdge,
                isFirefox,
                isSafari,
                name: isChrome && !isEdge ? 'Chrome' : isEdge ? 'Edge' : isFirefox ? 'Firefox' : isSafari ? 'Safari' : 'Unknown'
            };
        }

        function checkBrowserCompatibility() {
            const browser = detectBrowser();
            const hasSpeechRecognition = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
            
            if (!browser.isChrome && !browser.isEdge) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'status-message status-error browser-warning';
                warningDiv.innerHTML = `
                    <strong>⚠️ Browser Compatibility Warning</strong><br>
                    You're using ${browser.name}. For best voice recognition performance, please use <strong>Google Chrome</strong>.<br><br>
                    
                    <strong>🔧 Quick Fix Options:</strong><br>
                    <strong>Option 1 - Copy URL to Chrome:</strong><br>
                    1. Copy this URL: <div class="url-copy">${window.location.href}</div>
                    2. Open Google Chrome<br>
                    3. Paste the URL and press Enter<br><br>
                    
                    <strong>Option 2 - Download Chrome:</strong><br>
                    <a href="https://www.google.com/chrome/" target="_blank" style="color: #fff; text-decoration: underline;">Download Google Chrome (Free)</a><br><br>
                    
                    <strong>Option 3 - Use Manual Entry:</strong><br>
                    You can still use this app by typing student names manually instead of voice recording.
                `;
                
                const container = document.querySelector('.content');
                container.insertBefore(warningDiv, container.firstChild);
            } else if (!hasSpeechRecognition) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'status-message status-error';
                warningDiv.innerHTML = `
                    <strong>❌ Speech Recognition Not Available</strong><br>
                    Your browser doesn't support speech recognition. Please try:<br>
                    1. Using Google Chrome (recommended)<br>
                    2. Enabling microphone permissions<br>
                    3. Using HTTPS (required for microphone access)
                `;
                
                const container = document.querySelector('.content');
                container.insertBefore(warningDiv, container.firstChild);
            } else if (browser.isChrome || browser.isEdge) {
                setTimeout(() => {
                    updateStatus(`✅ Great! ${browser.name} supports voice recognition perfectly.`, 'success');
                }, 1000);
            }
        }

        async function checkMicrophoneStatus() {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'microphoneStatus';
            statusDiv.className = 'status-message status-info';
            
            let statusHTML = '<strong>🔍 Microphone Diagnostics:</strong><br>';
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                statusHTML += '❌ <strong>HTTPS Required:</strong> Microphone access requires HTTPS. ';
                statusHTML += 'This page is served over HTTP which blocks microphone access.<br>';
            } else {
                statusHTML += '✅ HTTPS: Page is secure<br>';
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                statusHTML += '❌ <strong>Speech Recognition:</strong> Not supported in this browser<br>';
            } else {
                statusHTML += '✅ Speech Recognition: Supported<br>';
            }
            
            if (!navigator.mediaDevices) {
                statusHTML += '❌ <strong>Media Devices:</strong> Not available (likely HTTP instead of HTTPS)<br>';
            } else {
                statusHTML += '✅ Media Devices: Available<br>';
            }
            
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const permissionStatus = await navigator.permissions.query({name: 'microphone'});
                    statusHTML += `📋 <strong>Permission Status:</strong> ${permissionStatus.state}<br>`;
                    
                    if (permissionStatus.state === 'denied') {
                        statusHTML += '⚠️ <strong>Fix:</strong> Go to Chrome Settings > Privacy > Microphone, find this site, and allow access<br>';
                    }
                } else {
                    statusHTML += '⚠️ Permission status: Cannot check (try manual permission grant)<br>';
                }
            } catch (e) {
                statusHTML += '⚠️ Permission check failed: ' + e.message + '<br>';
            }
            
            statusHTML += '<br><strong>📱 Mobile Chrome Steps:</strong><br>';
            statusHTML += '1. Tap the lock icon 🔒 in the address bar<br>';
            statusHTML += '2. Tap "Microphone" and select "Allow"<br>';
            statusHTML += '3. Refresh the page<br>';
            
            statusDiv.innerHTML = statusHTML;
            
            const container = document.querySelector('.content');
            const existingStatus = document.getElementById('microphoneStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            container.insertBefore(statusDiv, container.firstChild);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            const isSecure = checkAndRedirectToHTTPS();
            
            checkBrowserCompatibility();
            if (isSecure) {
                checkMicrophoneStatus();
            }
            initializeSpeechRecognition();
            loadExistingRuns();
            updateDisplay();
            
            // Create Run Button Event Listeners
            const createButton = document.getElementById('createRunBtn');
            if (createButton) {
                console.log('Setting up create button event listeners');
                
                // Remove any existing onclick handlers
                createButton.onclick = null;
                createButton.ontouchstart = null;
                
                // Add multiple event types for mobile compatibility
                createButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Create button clicked');
                    createNewRun();
                }, { passive: false });
                
                createButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    console.log('Create button touched');
                }, { passive: false });
                
                createButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Create button touch ended');
                    createNewRun();
                }, { passive: false });
                
                // Also try mousedown for broader compatibility
                createButton.addEventListener('mousedown', function(e) {
                    console.log('Create button mouse down');
                    setTimeout(() => createNewRun(), 50);
                });
                
                console.log('All event listeners added to create button');
            } else {
                console.error('Create button not found!');
            }
            
            // Enter key support for input field
            const runNameInput = document.getElementById('newRunName');
            if (runNameInput) {
                runNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        console.log('Enter key pressed, creating run');
                        createNewRun();
                    }
                });
            }
            
            // Run selection
            const runSelect = document.getElementById('runSelect');
            if (runSelect) {
                runSelect.addEventListener('change', function() {
                    console.log('Run selection changed:', this.value);
                    currentRun = this.value;
                    updateDisplay();
                    if (currentRun) {
                        updateStatus(`✅ Selected run: ${runs[currentRun].name}`, 'success');
                    }
                });
            }
            
            // Mobile detection and tips
            const debugDiv = document.getElementById('debugInfo');
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                console.log('Mobile device detected');
                if (debugDiv) {
                    debugDiv.innerHTML = 'Mobile device detected. Try the manual test button if the main button doesn\'t work.';
                }
                setTimeout(() => {
                    updateStatus('📱 Mobile detected. If "Create New Run" doesn\'t work, try the manual test button below.', 'info');
                }, 3000);
            }
            
            // Global error handler
            window.addEventListener('error', function(e) {
                console.error('Page error:', e.error);
                if (debugDiv) {
                    debugDiv.innerHTML += `<br><strong style="color: red;">Page Error: ${e.error.message}</strong>`;
                }
            });
            
            console.log('Initialization complete');
        });
    </script>
</body>
</html>
